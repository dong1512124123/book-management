<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{fragments/header :: styles}">
    <title>도서 등록</title>
</head>
<body>
    <nav th:replace="~{fragments/header :: navbar}"></nav>
    <div th:replace="~{fragments/header :: sidebar}"></div>

    <div class="main-content">
    <div class="container-fluid" style="max-width: 600px;">
        <div class="page-header">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="/dashboard">홈</a></li>
                    <li class="breadcrumb-item"><a href="/books">도서 목록</a></li>
                    <li class="breadcrumb-item active"
                        th:text="${book.id != null} ? '도서 수정' : '도서 등록'">도서 등록</li>
                </ol>
            </nav>
            <h2 th:text="${book.id != null} ? '도서 수정' : '도서 등록'">도서 등록</h2>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="card">
            <div class="card-body">
                <form th:action="${book.id != null} ? @{/books/{id}/edit(id=${book.id})} : @{/books}"
                      th:object="${book}" method="post" enctype="multipart/form-data">

                    <div class="mb-3">
                        <label class="form-label fw-bold">제목 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" th:field="*{title}"
                               placeholder="도서 제목을 입력하세요" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">저자 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" th:field="*{author}"
                               placeholder="저자명을 입력하세요" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">출판사 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" th:field="*{publisher}"
                               placeholder="출판사를 입력하세요" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ISBN <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" th:field="*{isbn}"
                               id="isbnInput" placeholder="978-89-12345-67-8" maxlength="17" required>
                        <div class="form-text">숫자만 입력하면 자동으로 하이픈(-)이 삽입됩니다.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">개요</label>
                        <textarea class="form-control" th:field="*{description}" rows="5"
                                  placeholder="도서 개요를 입력하세요 (선택)"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">표지 이미지</label>
                        <!-- 수정 시 기존 이미지 표시 -->
                        <div th:if="${book.id != null and book.coverImage != null}" class="mb-2">
                            <img th:src="@{'/uploads/covers/' + ${book.coverImage}}" alt="현재 표지"
                                 style="max-height:150px; border-radius:8px; border:1px solid #dee2e6;">
                            <div class="form-check mt-1">
                                <input class="form-check-input" type="checkbox" name="deleteCover" id="deleteCover" value="true">
                                <label class="form-check-label text-muted" for="deleteCover">표지 이미지 삭제</label>
                            </div>
                        </div>
                        <input type="file" class="form-control" name="coverFile" id="coverFile" accept="image/*">
                        <div class="form-text">JPG, PNG 등 이미지 파일 (최대 5MB)</div>
                        <!-- 이미지 미리보기 -->
                        <div id="coverPreview" class="mt-2" style="display:none;">
                            <img id="previewImg" src="" alt="미리보기"
                                 style="max-height:150px; border-radius:8px; border:1px solid #dee2e6;">
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>
                            <span th:text="${book.id != null} ? '수정 완료' : '등록하기'">등록하기</span>
                        </button>
                        <a href="/books" class="btn btn-outline-secondary">취소</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ISBN 자동 하이픈 (978-89-12345-67-8 형식, 3-2-5-2-1)
        document.getElementById('isbnInput').addEventListener('input', function(e) {
            var val = this.value.replace(/[^0-9]/g, ''); // 숫자만 남기기
            var result = '';
            // 3-2-5-2-1 패턴으로 하이픈 삽입
            for (var i = 0; i < val.length && i < 13; i++) {
                if (i === 3 || i === 5 || i === 10 || i === 12) result += '-';
                result += val[i];
            }
            this.value = result;
        });

        // 표지 이미지 미리보기
        document.getElementById('coverFile').addEventListener('change', function(e) {
            var file = e.target.files[0];
            var preview = document.getElementById('coverPreview');
            var img = document.getElementById('previewImg');
            if (file) {
                var reader = new FileReader();
                reader.onload = function(ev) {
                    img.src = ev.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });
    </script>
</body>
</html>
