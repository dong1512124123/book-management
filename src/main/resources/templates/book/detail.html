<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{fragments/header :: styles}">
    <title>도서 상세</title>
</head>
<body>
    <nav th:replace="~{fragments/header :: navbar}"></nav>
    <div th:replace="~{fragments/header :: sidebar}"></div>

    <!-- isUserView: 사용자 화면인지 판별 -->
    <div class="main-content" th:with="isUserView=${from == 'user-books' or from == 'my-loans'}">
    <div class="container-fluid" style="max-width: 800px;">

        <!-- 브레드크럼 -->
        <div class="page-header">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li th:if="${isUserView}" class="breadcrumb-item"><a href="/user/dashboard">홈</a></li>
                    <li th:unless="${isUserView}" class="breadcrumb-item"><a href="/dashboard">홈</a></li>
                    <li th:if="${isUserView}" class="breadcrumb-item"><a href="/user/books">도서 목록</a></li>
                    <li th:unless="${isUserView}" class="breadcrumb-item"><a href="/books">도서 목록</a></li>
                    <li class="breadcrumb-item active">도서 상세</li>
                </ol>
            </nav>
        </div>

        <!-- 성공/에러 메시지 -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-1"></i>
            <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- ===== 도서 정보 카드 ===== -->
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <div class="row">
                    <!-- 왼쪽: 도서 표지 -->
                    <div class="col-md-4 text-center mb-3 mb-md-0">
                        <div th:if="${book.coverImage != null}" style="border-radius: 12px; overflow: hidden; min-height: 240px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                            <img th:src="@{'/uploads/covers/' + ${book.coverImage}}" alt="도서 표지"
                                 style="max-width: 100%; max-height: 320px; border-radius: 12px; object-fit: contain;">
                        </div>
                        <div th:unless="${book.coverImage != null}" style="background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); border-radius: 12px; padding: 40px 20px; min-height: 240px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <i class="bi bi-book" style="font-size: 4rem; color: #adb5bd;"></i>
                            <p class="text-muted mt-2 mb-0" style="font-size: 0.85rem;">도서 표지</p>
                        </div>
                    </div>
                    <!-- 오른쪽: 도서 정보 -->
                    <div class="col-md-8">
                        <div class="d-flex align-items-start justify-content-between mb-2">
                            <h4 class="fw-bold mb-0" th:text="${book.title}">도서 제목</h4>
                            <span th:if="${isBorrowed}" class="badge badge-borrowed fs-6 ms-2 flex-shrink-0">대출 중</span>
                            <span th:unless="${isBorrowed}" class="badge badge-available fs-6 ms-2 flex-shrink-0">비치 중</span>
                        </div>

                        <table class="table table-borderless table-sm mt-3 mb-0" style="font-size: 0.93rem;">
                            <tr>
                                <td style="width:90px" class="text-muted py-1"><i class="bi bi-person me-1"></i>저자</td>
                                <td class="py-1" th:text="${book.author}"></td>
                            </tr>
                            <tr>
                                <td class="text-muted py-1"><i class="bi bi-building me-1"></i>출판사</td>
                                <td class="py-1" th:text="${book.publisher}"></td>
                            </tr>
                            <tr>
                                <td class="text-muted py-1"><i class="bi bi-upc-scan me-1"></i>ISBN</td>
                                <td class="py-1 isbn-cell" th:text="${book.isbn}"></td>
                            </tr>
                            <tr>
                                <td class="text-muted py-1"><i class="bi bi-calendar3 me-1"></i>등록일</td>
                                <td class="py-1" th:text="${book.createdAt != null} ? ${#temporals.format(book.createdAt, 'yyyy-MM-dd')} : '-'"></td>
                            </tr>
                            <tr>
                                <td class="text-muted py-1"><i class="bi bi-tag me-1"></i>상태</td>
                                <td class="py-1">
                                    <span th:if="${isBorrowed}" class="text-danger fw-bold">대출 중</span>
                                    <span th:unless="${isBorrowed}" class="text-success fw-bold">대출 가능</span>
                                </td>
                            </tr>
                        </table>

                        <!-- 관리자: 수정/삭제/이력다운로드 버튼 -->
                        <div th:unless="${isUserView}" class="mt-3 d-flex gap-2">
                            <a th:href="@{/books/{id}/edit(id=${book.id})}" class="btn btn-primary btn-sm">
                                <i class="bi bi-pencil me-1"></i>도서 정보 수정
                            </a>
                            <form th:action="@{/books/{id}/delete(id=${book.id})}" method="post"
                                  onsubmit="return confirm('정말 삭제하시겠습니까?')">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-trash me-1"></i>삭제
                                </button>
                            </form>
                            <div class="dropup">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-download me-1"></i>대출 이력 다운로드
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" th:href="@{/pdf/books/{id}/loan-history(id=${book.id})}">
                                        <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>PDF
                                    </a></li>
                                    <li><a class="dropdown-item" th:href="@{/excel/books/{id}/loan-history(id=${book.id})}">
                                        <i class="bi bi-file-earmark-excel me-2 text-success"></i>Excel
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 도서 소개 ===== -->
        <div th:if="${book.description != null and !book.description.isEmpty()}" class="card shadow-sm mt-3">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>도서 소개</h6>
            </div>
            <div class="card-body">
                <p class="mb-0" style="white-space: pre-line; line-height: 1.7; color: #495057;" th:text="${book.description}"></p>
            </div>
        </div>

        <!-- ===== 현재 대여 정보 (대출 중일 때만) ===== -->
        <div th:if="${activeLoan}" class="card shadow-sm mt-3">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-person-badge me-2"></i>현재 대여 정보</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-6">
                        <small class="text-muted">대여자</small>
                        <p class="mb-2 fw-bold" th:text="${borrowerName}"></p>
                    </div>
                    <div class="col-sm-6">
                        <small class="text-muted">연락처</small>
                        <p class="mb-2" th:text="${borrowerPhone}"></p>
                    </div>
                    <div class="col-sm-6">
                        <small class="text-muted">대출일</small>
                        <p class="mb-2" th:text="${activeLoan.borrowDate}"></p>
                    </div>
                    <div class="col-sm-6">
                        <small class="text-muted">반납예정일</small>
                        <p class="mb-2">
                            <span th:text="${activeLoan.returnDueDate}"></span>
                            <span th:if="${activeLoan.overdue}" class="badge bg-danger ms-1">연체</span>
                        </p>
                    </div>
                    <div class="col-12">
                        <small class="text-muted">상태</small>
                        <p class="mb-0">
                            <span th:if="${activeLoan.status == 'REQUESTED'}" class="badge badge-requested">승인 대기</span>
                            <span th:if="${activeLoan.status == 'APPROVED' && !activeLoan.overdue}" class="badge badge-approved">대출 중</span>
                            <span th:if="${activeLoan.status == 'APPROVED' && activeLoan.overdue}" class="badge badge-overdue">연체</span>
                            <span th:if="${activeLoan.status == 'RETURN_REQUESTED'}" class="badge badge-return-requested">반납 대기</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 사용자: 대출 신청 버튼 ===== -->
        <div th:if="${isUserView && !isBorrowed}" class="mt-3">
            <form th:action="@{/user/books/{id}/request(id=${book.id})}" method="post">
                <button type="submit" class="btn btn-primary w-100"
                        onclick="return confirm('이 도서의 대출을 신청하시겠습니까?')">
                    <i class="bi bi-book me-1"></i>대출 신청
                </button>
            </form>
        </div>

        <!-- ===== 대출 이력 ===== -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    <span th:text="${isUserView} ? '도서 대출 이력' : '대출 이력 및 관리'">대출 이력</span>
                    <span class="badge bg-secondary ms-1" th:text="${loanHistory != null} ? ${#lists.size(loanHistory)} + '건' : '0건'"></span>
                </h6>
            </div>
            <div class="card-body p-0">
                <div th:if="${loanHistory != null && !#lists.isEmpty(loanHistory)}" class="table-responsive">
                    <table class="table table-hover mb-0" style="font-size: 0.88rem;">
                        <thead class="table-light">
                            <tr>
                                <th>대여자</th>
                                <th>대출일</th>
                                <th>반납예정일</th>
                                <th>반납일</th>
                                <th>상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="loan : ${loanHistory}">
                                <!-- 관리자: 이름 전체, 사용자: 마스킹 -->
                                <td th:if="${!isUserView}" th:text="${loan.member.name}"></td>
                                <td th:if="${isUserView}" th:text="${loan.member.name.length() > 0} ? ${loan.member.name.substring(0,1)} + '**' : ''"></td>
                                <td th:text="${loan.borrowDate}"></td>
                                <td th:text="${loan.returnDueDate}"></td>
                                <td th:text="${loan.returnedDate != null} ? ${loan.returnedDate} : '-'"></td>
                                <td>
                                    <span th:if="${loan.status == 'REQUESTED'}" class="badge badge-requested">승인 대기</span>
                                    <span th:if="${loan.status == 'APPROVED' && (loan.returnedDate == null) && !loan.overdue}" class="badge badge-approved">대출 중</span>
                                    <span th:if="${loan.status == 'APPROVED' && (loan.returnedDate == null) && loan.overdue}" class="badge badge-overdue">연체</span>
                                    <span th:if="${loan.status == 'RETURN_REQUESTED'}" class="badge badge-return-requested">반납 대기</span>
                                    <span th:if="${loan.status == 'RETURNED'}" class="badge bg-secondary">반납 완료</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${loanHistory == null || #lists.isEmpty(loanHistory)}" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">대출 이력이 없습니다.</p>
                </div>
            </div>
        </div>

        <!-- ===== 하단 돌아가기 버튼 ===== -->
        <div class="mt-3 mb-4">
            <a th:href="${from == 'my-loans'} ? '/user/my-loans' : (${from == 'user-books'} ? '/user/books' : (${from == 'dashboard'} ? '/dashboard' : (${from == 'loans'} ? '/loans' : '/books')))"
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>
                <span th:text="${from == 'my-loans'} ? '대출현황으로' : (${from == 'user-books'} ? '도서목록으로' : (${from == 'dashboard'} ? '현황으로' : (${from == 'loans'} ? '대출목록으로' : '도서목록으로')))">목록으로</span>
            </a>
        </div>

    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ISBN 표시 서식 (3-2-5-2-1)
        document.querySelectorAll('.isbn-cell').forEach(function(td) {
            var val = td.textContent.replace(/[^0-9]/g, '');
            if (val.length === 13) {
                td.textContent = val.slice(0,3)+'-'+val.slice(3,5)+'-'+val.slice(5,10)+'-'+val.slice(10,12)+'-'+val.slice(12);
            }
        });
    </script>
</body>
</html>
