<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<!--
    공통 헤더 + 사이드바 조각(Fragment)
    모든 페이지에서 th:replace로 재사용됨
    → GNB(상단) + LNB(좌측 사이드바) 구조
-->

<!-- 공통 CSS -->
<head th:fragment="styles">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e56a0;
            --primary-light: #3b82f6;
            --primary-dark: #163d72;
            --sidebar-width: 260px;
            --gnb-height: 56px;
        }
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            padding-top: var(--gnb-height);
        }
        /* === GNB (상단 바) === */
        .navbar-custom {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            height: var(--gnb-height);
            z-index: 1030;
        }
        .navbar-custom .navbar-brand {
            font-weight: 700;
            font-size: 1.3rem;
            color: #fff;
        }
        .navbar-custom .navbar-brand i {
            color: #93c5fd;
        }
        .navbar-custom .nav-link {
            color: rgba(255,255,255,0.85);
            font-weight: 500;
            padding: 0.5rem 0.8rem;
            transition: all 0.2s;
        }
        .navbar-custom .nav-link:hover {
            color: #fff;
        }
        /* 알림 뱃지 */
        .notification-badge {
            position: relative;
        }
        .notification-badge .badge {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.65rem;
            padding: 0.2em 0.45em;
        }
        /* 사용자 정보 */
        .user-info {
            color: rgba(255,255,255,0.9);
            font-size: 0.88rem;
        }
        /* GNB 관리자 메뉴 활성 */
        .gnb-menu.active-cat {
            color: #fff !important;
            background-color: rgba(255,255,255,0.15);
            border-radius: 6px;
        }

        /* === LNB (좌측 사이드바) === */
        .sidebar {
            width: var(--sidebar-width);
            position: fixed;
            top: var(--gnb-height);
            left: 0;
            bottom: 0;
            background: #fff;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            z-index: 1020;
            padding-top: 0.5rem;
            transition: transform 0.3s;
        }
        .sidebar-menu-title {
            font-size: 0.72rem;
            font-weight: 700;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 1.2rem 0.3rem;
        }
        .sidebar .nav-link {
            color: #555;
            font-size: 0.92rem;
            padding: 0.55rem 1.2rem;
            border-radius: 0;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sidebar .nav-link:hover {
            background-color: #eff6ff;
            color: var(--primary-color);
        }
        .sidebar .nav-link.active {
            background-color: #dbeafe;
            color: var(--primary-color);
            font-weight: 600;
            border-right: 3px solid var(--primary-color);
        }
        .sidebar .nav-link i {
            width: 20px;
            text-align: center;
            color: var(--primary-light);
            font-size: 1rem;
        }
        .sidebar .nav-link.active i {
            color: var(--primary-color);
        }
        /* 카테고리 헤더 (접기/펴기) */
        .sidebar .menu-category {
            color: #444;
            font-size: 0.92rem;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        .sidebar .menu-category:hover {
            background-color: #f0f7ff;
            color: var(--primary-color);
        }
        .sidebar .menu-category i.cat-icon {
            width: 20px;
            text-align: center;
            color: var(--primary-light);
        }
        .sidebar .menu-category .arrow {
            margin-left: auto;
            font-size: 0.75rem;
            transition: transform 0.2s;
            color: #bbb;
        }
        .sidebar .menu-category[aria-expanded="true"] .arrow {
            transform: rotate(90deg);
        }
        /* 서브메뉴 */
        .sidebar .sub-menu .nav-link {
            padding-left: 2.8rem;
            font-size: 0.88rem;
        }
        /* 구분선 */
        .sidebar hr {
            margin: 0.5rem 1rem;
            border-color: #f0f0f0;
        }
        /* 관리자 LNB 카테고리 섹션 (기본 숨김, JS로 활성 카테고리만 표시) */
        .lnb-section {
            display: none;
        }
        .lnb-section.active-section {
            display: block;
        }

        /* === 메인 콘텐츠 === */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            min-height: calc(100vh - var(--gnb-height));
        }
        /* auth 페이지 (LNB 없는 전체 너비) */
        .main-content-full {
            margin-left: 0;
            padding: 1.5rem;
        }

        /* === 카드 공통 스타일 === */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 12px 12px 0 0 !important;
            padding: 1rem 1.25rem;
        }
        /* 대시보드 통계 카드 */
        .stat-card {
            border-left: 4px solid;
            padding: 1.5rem;
        }
        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }
        .stat-card .stat-label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.3rem;
        }
        .stat-card .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }
        /* 테이블 스타일 */
        .table th {
            font-weight: 600;
            font-size: 0.88rem;
            color: #666;
            border-bottom: 2px solid #e9ecef;
        }
        .table td {
            vertical-align: middle;
            font-size: 0.92rem;
        }
        /* 뱃지 스타일 */
        .badge-borrowed {
            background-color: #fee2e2;
            color: #dc2626;
            font-weight: 600;
            padding: 0.35em 0.8em;
        }
        .badge-available {
            background-color: #dcfce7;
            color: #16a34a;
            font-weight: 600;
            padding: 0.35em 0.8em;
        }
        .badge-returned {
            background-color: #dbeafe;
            color: #1e56a0;
            font-weight: 600;
            padding: 0.35em 0.8em;
        }
        .badge-overdue {
            background-color: #fef3c7;
            color: #d97706;
            font-weight: 600;
            padding: 0.35em 0.8em;
        }
        .badge-requested {
            background-color: #fef3c7;
            color: #d97706;
            font-weight: 600;
            padding: 0.35em 0.8em;
        }
        .badge-approved {
            background-color: #dbeafe;
            color: #2563eb;
            font-weight: 600;
            padding: 0.35em 0.8em;
        }
        .badge-return-requested {
            background-color: #fce7f3;
            color: #db2777;
            font-weight: 600;
            padding: 0.35em 0.8em;
        }
        /* 페이지 타이틀 */
        .page-header {
            margin-bottom: 1.5rem;
        }
        .page-header h2 {
            font-weight: 700;
            color: #333;
        }
        .page-header .breadcrumb {
            font-size: 0.85rem;
        }
        /* 버튼 스타일 */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* === 반응형 === */
        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: var(--gnb-height);
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.3);
                z-index: 1019;
            }
            .sidebar-overlay.show {
                display: block;
            }
        }
    </style>
</head>

<!-- GNB (상단 바) -->
<nav th:fragment="navbar" class="navbar navbar-expand navbar-custom fixed-top">
    <div class="container-fluid px-3">
        <!-- 모바일 사이드바 토글 -->
        <button class="btn btn-link text-white d-lg-none me-2 p-0" onclick="toggleSidebar()" style="font-size:1.3rem;">
            <i class="bi bi-list"></i>
        </button>

        <!-- 로고 -->
        <a class="navbar-brand" href="/dashboard" sec:authorize="hasRole('ADMIN')">
            <i class="bi bi-book-half me-2"></i>LibraryGO
        </a>
        <a class="navbar-brand" href="/user/dashboard" sec:authorize="hasRole('USER')">
            <i class="bi bi-book-half me-2"></i>LibraryGO
        </a>

        <!-- 관리자 GNB 메뉴 -->
        <ul class="navbar-nav ms-3 d-none d-lg-flex" sec:authorize="hasRole('ADMIN')">
            <li class="nav-item">
                <a class="nav-link gnb-menu" href="#" data-cat="notice" onclick="selectGnbCat(event,'notice')">
                    <i class="bi bi-megaphone me-1"></i>공지사항
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link gnb-menu" href="#" data-cat="book" onclick="selectGnbCat(event,'book')">
                    <i class="bi bi-journal-bookmark-fill me-1"></i>도서 관리
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link gnb-menu" href="#" data-cat="member" onclick="selectGnbCat(event,'member')">
                    <i class="bi bi-people-fill me-1"></i>회원 관리
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link gnb-menu" href="#" data-cat="loan" onclick="selectGnbCat(event,'loan')">
                    <i class="bi bi-arrow-left-right me-1"></i>대출 관리
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link gnb-menu" href="#" data-cat="history" onclick="selectGnbCat(event,'history')">
                    <i class="bi bi-clock-history me-1"></i>이력 관리
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link gnb-menu" href="#" data-cat="setting" onclick="selectGnbCat(event,'setting')">
                    <i class="bi bi-gear me-1"></i>설정
                </a>
            </li>
        </ul>

        <!-- 오른쪽: 매뉴얼 + 알림 + 사용자 정보 + 로그아웃 -->
        <ul class="navbar-nav ms-auto align-items-center">
            <!-- 매뉴얼 링크 -->
            <li class="nav-item me-1" sec:authorize="hasRole('ADMIN')">
                <a class="nav-link" href="/docs/1_관리자매뉴얼.pdf" target="_blank"
                   style="color:rgba(255,255,255,0.85);">
                    <i class="bi bi-journal-text"></i>
                    <span class="d-none d-md-inline ms-1" style="font-size:0.85rem;">매뉴얼</span>
                </a>
            </li>
            <li class="nav-item me-1" sec:authorize="hasRole('USER')">
                <a class="nav-link" href="/docs/2_사용자매뉴얼.pdf" target="_blank"
                   style="color:rgba(255,255,255,0.85);">
                    <i class="bi bi-journal-text"></i>
                    <span class="d-none d-md-inline ms-1" style="font-size:0.85rem;">매뉴얼</span>
                </a>
            </li>
            <!-- 알림 아이콘 -->
            <li class="nav-item notification-badge me-2">
                <a class="nav-link" href="/notifications">
                    <i class="bi bi-bell-fill"></i>
                    <span class="badge bg-danger rounded-pill"
                          th:if="${unreadNotifications != null && unreadNotifications > 0}"
                          th:text="${unreadNotifications}"></span>
                </a>
            </li>
            <!-- 사용자 정보 -->
            <li class="nav-item d-none d-sm-block">
                <span class="user-info me-2">
                    <i class="bi bi-person-circle me-1"></i>
                    <span sec:authentication="name">사용자</span>
                    <span class="badge bg-light text-dark ms-1" sec:authorize="hasRole('ADMIN')">관리자</span>
                </span>
            </li>
            <!-- 로그아웃 -->
            <li class="nav-item">
                <form th:action="@{/auth/logout}" method="post" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-box-arrow-right me-1"></i>로그아웃
                    </button>
                </form>
            </li>
        </ul>
    </div>
</nav>

<!-- LNB (좌측 사이드바) -->
<div th:fragment="sidebar">
    <!-- 모바일 오버레이 -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <!-- ===== 관리자 메뉴 (카테고리별 분리) ===== -->
        <nav sec:authorize="hasRole('ADMIN')">

            <!-- 공지사항 카테고리 -->
            <div class="lnb-section" data-cat="notice">
                <div class="sidebar-menu-title"><i class="bi bi-megaphone me-1"></i>공지사항</div>
                <a class="nav-link" href="/admin/notices" data-page="admin-notices">
                    <i class="bi bi-list-ul"></i> 공지 목록
                </a>
                <a class="nav-link" href="/admin/notices/new" data-page="admin-notices-new">
                    <i class="bi bi-plus-circle"></i> 공지 작성
                </a>
            </div>

            <!-- 도서 관리 카테고리 -->
            <div class="lnb-section" data-cat="book">
                <div class="sidebar-menu-title"><i class="bi bi-journal-bookmark-fill me-1"></i>도서 관리</div>
                <a class="nav-link" href="/books" data-page="books">
                    <i class="bi bi-list-ul"></i> 도서 목록
                </a>
                <a class="nav-link" href="/books/new" data-page="books-new">
                    <i class="bi bi-plus-circle"></i> 도서 등록
                </a>
            </div>

            <!-- 회원 관리 카테고리 -->
            <div class="lnb-section" data-cat="member">
                <div class="sidebar-menu-title"><i class="bi bi-people-fill me-1"></i>회원 관리</div>
                <a class="nav-link" href="/members" data-page="members">
                    <i class="bi bi-person-lines-fill"></i> 회원 목록
                </a>
            </div>

            <!-- 대출 관리 카테고리 -->
            <div class="lnb-section" data-cat="loan">
                <div class="sidebar-menu-title"><i class="bi bi-arrow-left-right me-1"></i>대출 관리</div>
                <a class="nav-link" href="/loans" data-page="loans">
                    <i class="bi bi-card-list"></i> 대출/반납 목록
                </a>
            </div>

            <!-- 이력 관리 카테고리 -->
            <div class="lnb-section" data-cat="history">
                <div class="sidebar-menu-title"><i class="bi bi-clock-history me-1"></i>이력 관리</div>
                <a class="nav-link" href="/admin/history/login" data-page="history-login">
                    <i class="bi bi-person-check"></i> 로그인 이력
                </a>
            </div>

            <!-- 설정 카테고리 -->
            <div class="lnb-section" data-cat="setting">
                <div class="sidebar-menu-title"><i class="bi bi-gear me-1"></i>설정</div>
                <a class="nav-link" href="/admin/profile" data-page="admin-profile">
                    <i class="bi bi-person-gear"></i> 내 정보 수정
                </a>
            </div>

            <!-- 대시보드 (GNB에 해당 카테고리 없을 때) -->
            <div class="lnb-section" data-cat="dashboard">
                <div class="sidebar-menu-title"><i class="bi bi-speedometer2 me-1"></i>대시보드</div>
                <a class="nav-link active" href="/dashboard" data-page="dashboard">
                    <i class="bi bi-speedometer2"></i> 대시보드 홈
                </a>
            </div>
        </nav>

        <!-- ===== 사용자 메뉴 ===== -->
        <nav sec:authorize="hasRole('USER')">
            <div class="sidebar-menu-title">메뉴</div>

            <a class="nav-link" href="/user/dashboard" data-page="user-dashboard">
                <i class="bi bi-speedometer2"></i> 대시보드
            </a>
            <a class="nav-link" href="/user/notices" data-page="user-notices">
                <i class="bi bi-megaphone"></i> 공지사항
            </a>
            <a class="nav-link" href="/user/books" data-page="user-books">
                <i class="bi bi-book"></i> 도서 목록
            </a>
            <a class="nav-link" href="/user/my-loans" data-page="user-my-loans">
                <i class="bi bi-journal-text"></i> 내 대출 현황
            </a>

            <hr>
            <div class="sidebar-menu-title">설정</div>

            <a class="nav-link" href="/user/profile" data-page="user-profile">
                <i class="bi bi-person-gear"></i> 내 정보
            </a>
        </nav>
    </div>

    <!-- 사이드바 활성 메뉴 + GNB 연동 스크립트 -->
    <script>
        // GNB 메뉴 클릭 → 해당 LNB 카테고리 표시 (페이지 이동 안 함)
        function selectGnbCat(e, cat) {
            e.preventDefault();

            // GNB 활성 표시 갱신
            document.querySelectorAll('.gnb-menu[data-cat]').forEach(function(link) {
                link.classList.remove('active-cat');
            });
            document.querySelector('.gnb-menu[data-cat="' + cat + '"]').classList.add('active-cat');

            // LNB 섹션 전환
            document.querySelectorAll('.lnb-section[data-cat]').forEach(function(sec) {
                sec.classList.remove('active-section');
            });
            var target = document.querySelector('.lnb-section[data-cat="' + cat + '"]');
            if (target) target.classList.add('active-section');

            // 선택한 카테고리 기억 (같은 탭 내에서 유지)
            sessionStorage.setItem('activeGnbCat', cat);
        }

        (function() {
            var path = window.location.pathname;

            // URL → { page, cat } 매핑
            var routeMap = [
                { prefix: '/admin/notices/new', page: 'admin-notices-new', cat: 'notice' },
                { prefix: '/admin/notices', page: 'admin-notices', cat: 'notice' },
                { prefix: '/books/new', page: 'books-new', cat: 'book' },
                { prefix: '/books', page: 'books', cat: 'book' },
                { prefix: '/members', page: 'members', cat: 'member' },
                { prefix: '/loans', page: 'loans', cat: 'loan' },
                { prefix: '/admin/history', page: 'history-login', cat: 'history' },
                { prefix: '/admin/profile', page: 'admin-profile', cat: 'setting' },
                { prefix: '/dashboard', page: 'dashboard', cat: 'dashboard' },
                { prefix: '/user/dashboard', page: 'user-dashboard', cat: null },
                { prefix: '/user/notices', page: 'user-notices', cat: null },
                { prefix: '/user/books', page: 'user-books', cat: null },
                { prefix: '/user/my-loans', page: 'user-my-loans', cat: null },
                { prefix: '/user/profile', page: 'user-profile', cat: null },
                { prefix: '/notifications', page: null, cat: null }
            ];

            var activePage = null;
            var activeCat = null;
            for (var i = 0; i < routeMap.length; i++) {
                if (path === routeMap[i].prefix || path.startsWith(routeMap[i].prefix + '/')) {
                    activePage = routeMap[i].page;
                    activeCat = routeMap[i].cat;
                    break;
                }
            }

            // 현재 URL에 매칭되는 카테고리가 있으면 우선 사용, 없으면 세션에서 복원
            var displayCat = activeCat || sessionStorage.getItem('activeGnbCat');

            // 1. GNB 활성 카테고리 하이라이트
            if (displayCat) {
                var gnbLinks = document.querySelectorAll('.gnb-menu[data-cat]');
                gnbLinks.forEach(function(link) {
                    if (link.getAttribute('data-cat') === displayCat) {
                        link.classList.add('active-cat');
                    }
                });
            }

            // 2. 관리자 LNB: 해당 카테고리 섹션만 표시
            if (displayCat) {
                var sections = document.querySelectorAll('.lnb-section[data-cat]');
                sections.forEach(function(sec) {
                    if (sec.getAttribute('data-cat') === displayCat) {
                        sec.classList.add('active-section');
                    }
                });
            }

            // 3. LNB 내 활성 링크 하이라이트
            if (activePage) {
                var links = document.querySelectorAll('.sidebar .nav-link[data-page]');
                links.forEach(function(link) {
                    if (link.getAttribute('data-page') === activePage) {
                        link.classList.add('active');
                    }
                });
            }
        })();

        // 모바일 사이드바 토글
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }
    </script>
</div>

</html>
